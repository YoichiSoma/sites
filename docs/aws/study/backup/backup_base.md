# バックアップについて考える
## ここで言及しないこと
- なぜバックアップをするのか
- AWSでできないことのバックアップ方法
  - ＊考え方や手法項目では軽く説明は入れている
- 各バックアップ手法に対しての具体的な設定方法

---
## 考えるべきこと
1. **どんなデータをバックアップしたいのか？**

   一言に"バックアップ"といっても、まずは何をバックアップするのかを考慮する必要がある。<br>
   大抵はシステム全体やディスク全体という観点で考える事が多いが稼働しているシステムによっては正常に復旧できない可能性がある。<br>
   また全体バックアップだと復旧に不要なデータ(一時キャッシュやTMPファイル、ゴミ箱等)までもバックアップすることにより、容量に無駄が出てくる可能性がある。<br>
   - <img src="https://github.com/YoichiSoma/sites/assets/125415634/8c9fac23-f61f-44a3-ad2e-5cd0b44692a2" width="400">
  - ファイル
    - コード
    - ドキュメント
    - 画像
  - データベース
  - システム
    - OS
    - ミドルウェア
 
2. **停止可否、取得時間**

   システムによっては静止点考慮する必要がある。<br>
   例えば書き込み中やファイルをオープン中にバックアップを行った場合正常に復旧できない可能性もあるためである。<br>
  
  - システム及びミドルウェアの停止可否
  - 停止可否の場合どれだけの時間停止してよいのか？
3. **RPO,RTO**

    バックアップを取得するということは同時に復旧することも考えないといけない。<br>
    提供しているサービスやシステムにもよるが復旧時間によってサービスへの影響も発生するためである。<br>
    <img src="https://github.com/YoichiSoma/sites/assets/125415634/667780af-d9a3-4b85-9143-6af336fecd98" width="600">
  - RPO
    - RecoveryPointObjective
    - 目標復旧時点
    - どの時点
  - RTO
    - RecoveryTimeObjective
    - 目標復旧時間
    - いつまで
  

3. 復旧粒度

   システムによってはファイルだけ復旧すれば良いものもあれば、全体的に復旧する必要があるものもある。<br>
   また前項のRTOにも関わるが、システム全体を復旧すると時間がかかりすぎるという場合もあるため、粒度も考慮するとよい。<br>

  - ファイルだけ
  - ミドルウェアに必要なデータ
    - データベース
    - ミドルウェアに必要なファイル(コード等)
  - システム全体

---

## バックアップの手法概要
### イメージバックアップ

<img src="https://github.com/YoichiSoma/sites/assets/125415634/ef66f77e-1d8d-4763-abdb-704e53af690d" width="600">

- システム、あるいはドライブ単位でのバックアップ
- スナップショットと言われるものは大抵この形式になる
- メリット
  - システム、ドライブ全体でバックアップを取得するので細かい点を考慮する必要がない
  - 全体でバックアップするので取得した時点までほぼそのまま復旧される
  - イメージコピーのようなシステムを複製する際にも利用できる
  - バックアップ機能によっては差分バックアップも可能なので保存容量の節約にもなる
- デメリット
  - 全体でのバックアップなので初回時や毎回フルバックアップの場合時間がかかることもある
  - 個別のファイルの抜き出しには基本対応していない
  - 基本システムを停止、あるいはシステムにアクセスがない状態で取得しないとファイルが破損する恐れがある

### レプリケーション

<img src="https://github.com/YoichiSoma/sites/assets/125415634/041e1f8b-6cfb-4b92-a4f1-86fc2deed488" width="500">

- 主にデータベースやファイルシステムで使われる手法である
- バックアップとは違う考え方かもしれないが可用性を担保するという意味ではバックアップ相当と考えてもよいかも
- Read/Write構成もとれるため、データベースの場合負荷分散として利用されることも多い
- メリット
  - 障害が起きた場合、復旧するまでの時間が一番早いと思わる
  - 設計によっては保存先をReadとして利用できるのでシステムの負荷分散を行うこともできる
  - ディザスタリカバリ（Disaster Recovery）的に離れたロケーションでも利用し易い
- デメリット
  - 基本バックアップ元と同じ保存容量が必要なため、ランニングコストが重複となる
  - 静止点保存ではないのでデータが改ざんされた場合、同じデータがコピーされてしまう
  - 設計が複雑なものもあるため構築難易度は高い場合もある

### 別のシステムへの保存

<img src="https://github.com/YoichiSoma/sites/assets/125415634/ce317b90-8bdd-417f-bbba-ffe3f2b5d66b" width="500">

- 主にコード管理に利用される方法
  - GitHubやCodeCommit等
- S3等のクラウドストレージに保存するのもある意味この形式である
- 稼働するシステムとは別に専用の管理サーバを用意し、管理をそちらで行う手法
- 更新が重複しても通知してくれるためオリジナルファイルが壊れることが少ない
- メリット
  - オリジナルデータは安全性の高い場所にあるため、システムが壊れても復旧し易い
  - 同じファイルを配布する場合には有効である
  - 重複通知等を行ってもらえるため、安心してコード作成ができる
- デメリット
  - ファイル単位であるためシステム全体が壊れた場合はファイルとは別にシステム復旧が必要である
  - 若干運用管理のお作法が独特であるため、運用コストは上がる
  - 別システムの方も別途バックアップ方法を検討可能性がある

### ミドルウェア特有の機能を使う
- DB系であれば"ダンプ"と言われる手法
- 他有償ライセンス系のミドルウェアであれば、ミドルウェア特有のバックアップ方法があるはず
- メリット
  - 特有の機能であるため、復旧精度は高い
  - システムを移行する際に利用できる
- デメリット
  - 別の場所に保管されるため、保管先のバックアップも考慮する必要あり
  - ミドルウェア毎の手順となるため、学習コストや運用コストを考慮する必要がある

---
## AWSで利用できるバックアップ手法
### [EBSスナップショット](https://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/EBSSnapshots.html)
- EC2にマウントしているEBSボリュームをバックアップする手法
  - 取得時点の状態で保存される
- 最初のスナップショットはフルスナップショットになるため、保存元と同じ容量が消費される
  - 以降は増えた分のみ消費される
- 保存先はS3だがAWS管理のため保存先のデータは参照できない
- 基本手動取得である
  - 自動取得する場合は以下のサービスを利用する
    - AWS Backup
    - Amazon Data Lifecycle Manager
- EC2インスタンスを削除してもスナップショットは削除されないのでこの点は注意が必要である

### [AMIイメージ作成](https://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/AMIs.html)
- 稼働しているシステム全体をイメージ化する手法
-   取得時点の状態で保存される
-   まるっとイメージ化されるのでバックアップ用途というより、同じシステムを展開するときによく使われる
-   EBSスナップショット同様手動で取得する必要がある
-   差分保存ではないので、作成した分だけ容量が増える
-   基本停止して作成となる
    - 停止しなくても取得できるがAWSとしては非推奨である

### RDS
- RDSは設定を入れることによりスナップショットを作成できる
  - https://docs.aws.amazon.com/ja_jp/AmazonRDS/latest/UserGuide/USER_WorkingWithAutomatedBackups.html

### S3
- バージョニング機能が存在するのでそちらでバックアップを行う
  - https://docs.aws.amazon.com/ja_jp/AmazonS3/latest/userguide/Versioning.html

### EFS
- 自動バックアップ機能が実装されている
  - AWS Backupを利用？
- レプリケーションやDataSyncでの実装も可能
- 参考
  - https://dev.classmethod.jp/articles/how-to-choose-amazon-efs-backup-solution/

### FSX for Windows
- EFS同様機能として実装されている
  - https://docs.aws.amazon.com/ja_jp/fsx/latest/WindowsGuide/using-backups.html
- Windowsの機能であるシャドウコピー機能でも実現できる
  - https://docs.aws.amazon.com/ja_jp/fsx/latest/WindowsGuide/manage-shadow-cpy.html

### [AWS Backup](https://docs.aws.amazon.com/ja_jp/aws-backup/latest/devguide/whatisbackup.html)
- AWS上の様々なリソースを統合的にバックアップできるサービス
  - ec2,s3,ebs,rds,FSx等
- リソースに対して一元管理や取得自動化ができるので複数のサービスをまとめて運用している場合は有用である
- バック・アップコンプライアンスの向上
  - 保持期間を設定
  - ライフサイクルを設定して自動削除することができる

---
## まとめ

AWSとしてのバックアップ手法はさほど多くないがVM観点のバックアップ、マネージド・サービス観点でのバックアップと基本は網羅されている<br>
AWSの機能としてどんなバックアップがあるかを考える前に何をバックアップすべきなのか、バックアップ時間や復旧時間、予算に合わせてまずはシステムやサービス観点での検討が必要である<br>

---

## 参考
- [CDP:Snapshotパターン](https://aws.clouddesignpattern.org/index.php/CDP_Snapshot%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3.html)
  - これはクラウドデザインパターン的にどのようにバックアップを取得するとよいという例である
