※　作成中
# EC2自動起動、自動停止の設定
## 概要
オンデマンドインスタンスを起動しておくと料金が発生する
検証時に停止をわすれてしまい、請求がすごいことになるかもしれない
なので自動で停止、更に平日日中帯に利用するのであれば起動設定もできるように

これを実現するためにに[EventBridge スケジューラ]を利用する

## やること
- IAMロール作成
  - EventBridgeサービスがEC2を起動するための権限付与が必要
- Amazon EventBridge スケジューラの設定


## 作業
### ポリシー作成
1. IAM > ポリシー > ポリシーの作成 にて作成画面に進む
2. アクセス許可を指定にて以下の設定を行い、[次へ]ボタンをクリックする
   - ポリシーエディタ項目にて[JSON]を選択し、以下のコードを入力
```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "VisualEditor0",
            "Effect": "Allow",
            "Action": [
                "ec2:StartInstances",
                "ec2:StopInstances"
            ],
            "Resource": "*"
        }
    ]
}
```
3. 確認して作成画面にてポリシー名を入力し、[ポリシーの作成]ボタンをクリックする
  - ポリシー名は"EC2-START_STOP"みたいな

### IAMロール作成
1. IAM > ロール > [ロールを作成] にて作成画面に進む
2. 「信頼されたエンティティを選択」画面にて以下のとおり設定し[次へ]をクリック
   - 信頼されたエンティティタイプ
     - カスタム信頼ポリシー
   - カスタム信頼ポリシーのエディタが費用じされたら以下のコードを入力
```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "Service": "scheduler.amazonaws.com"
            },
            "Action": "sts:AssumeRole"
        }
    ]
}
```
3. 「許可を追加」画面にて以下のポリシーを選択し、[次へ]ボタンをクリック
   - 許可ポリシー
     - 前項で作成したポリシー名を指定
4. 「名前、確認、および作成」画面にてロール名を設定し、[ロールを作成]ボタンをクリックする
   - ロール名は”role-ec2_auto”みたいな

### Amazon EventBridge スケジューラの設定
スケジュールは1度に1つの内容の実行になるため停止と起動の２つを作成する必要がある
#### 停止スケジュール作成
- EventBridge > スケジュール > スケジュールの作成 をクリック
- 「スケジュールの詳細の指定」画面にて以下の項目を設定し、[次へ]ボタンをクリックする
  - スケジュール名
    - "EB_SCR_EC2_STOP"みたいな
  - スケジュールのパターン
    - "定期的なスケジュール"を選択
    - タイムゾーン
      - (UTC+09:00) Asia/Tokyo ※デフォルトのまま
    - スケジュールの種類
      - "cronベースのスケジュール"を選択
      - cron式 
        - 停止を実行したい時間や曜日を指定する
        - 例) 金曜日の21時10分に実行したい場合
          - cron ( 10 21 > * FRI * )
        - 例) 毎日 20時20分に実行したい場合
        - [参考](https://qiita.com/da-sugi/items/ef3bb45a8a99a4acacb1)
   - フレックスタイムウィンドウ
     - 時間ぴったりではなく、ちょっと遅れても大丈夫な時間指定をする設定
     - 基本"オフ"でOK
 - その他記載のない項目はデフォルでOK
- ターゲットの選択画面で以下のように選択し、[次へ]ボタンをクリックする
  - "すべてのAPI"を選択
  - サービスを検索でec2を検索し、"Amazon EC2"を選択
  - APIを検索で"STOP"を検索し、表示された”StopInstances”を選択
  - 「入力」エディタ画面が表示されたら以下のように設定
```
{
  "InstanceIds": [
    "<停止を実行したいインスタンIDを指定>"
  ]
}
```
- スケジュールの状態画面で以下の通り設定し次へ
  - スケジュール完了後のアクション
    - DELETE or NONE
  - アクセス許可
    - 実行ロール
      - 既存のロールを使用
        - 作成したロールを指定
- スケジュールの確認と保存画面で内容を確認し、問題なければ[スケジュールを保存]ボタンをクリックする
#### 開始スケジュール
前項の設定手順にてターゲットを指定を"StartInstances"を指定すればOK

## その他
- 実行ログはCloudTailに記録される
  - イベント名が"StartInstances"や"StopInstances"で記録される
    - [参考](https://blog.serverworks.co.jp/2023/09/08/103355)
- 現状はインスタンスID指定なので作り直しをした場合イベント登録の変更が必要である
   - [この辺が参考になりそう](https://it-ouji.com/2021/10/11/aws-eventbridge%E3%81%A7ssm-automation%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%97%E3%81%A6%E7%89%B9%E5%AE%9A%E3%82%BF%E3%82%B0%E3%81%AEec2%E3%81%AE%E9%96%8B%E5%A7%8B%E3%81%A8%E5%81%9C%E6%AD%A2%E3%82%92/)
