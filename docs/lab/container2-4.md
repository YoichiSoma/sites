# lab2-4 CI/CD環境の構築
lab2-3までの設定で以下の構築を行った
  - CodeBuildでコンテナイメージの作成と、ECRリポジトリへのアップロード
  - ECSクラスタの作成
  - CodeDeployでクラスタ環境へBlue/Greenデプロイ

これらはすべて手動で実行しているのでCodePipelineを利用して、CodeCommitに作成したリポジトリーのMasterブランチに変更があった場合、自動的に上記処理を実行する環境を構築する。

---
## パイプライン作成

### タスク定義ファイルを作成
- タスク定義の最新板リビジョン内容を利用し、[taskdef.json]ファイルを作成する
- 最新版リビジョンのJSONファイルを開き、内容をコピー
- ファイルを作成し、以下の内容に変更
```
"image": "<IMAGE1_NAME>",
```
  - 下部にある”"tags": []”は削除する
  - その上にある行の最後の","は必要ないので消す(json的におかしくなるので)

- 作成したファイルをs3にアップロードする
```
aws s3 cp taskdef.json s3://nginx-test-dp-20230407/
```

### パイプライン作成
- デベロッパー用ツール > CodePipeline > パイプライン > 新規のパイプラインを作成する
- 「パイプラインの設定を選択する」画面にて以下を設定し、[次に]ボタンをクリックする
  - パイプライン名
    - nginx-pipeline
  - サービスロール
    - ”新しいサービスロール”を選択
  - ロール名
    - パイプライン名を入力すると自動的に入るのでそのままにする
- 「ソースステージを追加する」画面にて以下の設定を行い、[次に]ボタンをクリックする
  - ソースプロバイダー
    - ”AWS CodeCommit”を選択
  - リポジトリ名
    - ”php-sample”を選択
  - ブランチ名
    - "master"を選択
  - 以下設定はそのまま
- 「ビルドステージを追加する」画面にて以下の設定を行い、[次に]ボタンをクリックする
  - プロバイダーを構築する
    - "AWS CodeBuild"を選択
  - リージョン
    - アジアパシフィック(東京)
  - プロジェクト名
    - ”container-test”を指定
  - ビルドタイプ
    - 単一ビルドをトリガー
- 「デプロイステージを追加する」画面にて以下の設定を行い、[次に]ボタンをクリックする
  - デプロイプロバイダー
    - "Amazon ECS(ブルー/グリーン)"を選択
  - AWS CodeDeploy アプリケーション名
    - AppECS-nginx-cluster-nginx-fargate
  - AWS CodeDeploy デプロイグループ
    - DgpECS-Fargate-cluster-php-sample-fargate
  - Amazon ECS タスク定義
    - BuildArtifact
  - AWS CodeDeploy AppSpec ファイル
    - BuildArtifact
- 「レビュー」画面で[パイプラインを作成する]ボタンをクリックする
- パイプラインが実行されるが設定が足りていないのでDeployで失敗する

### パイプライン修正
- パイプライン画面にて画面上部にある[編集]ボタンをクリックし、「編集: Deploy」の[ステージを編集する]をクリック、Amazon ECS(ブルー/グリーン)の下にあるメモボタンをクリックする
- 「アクションを編集する」画面が表示されたら以下の通りに編集し、[完了]ボタンをクリックする
  - 入力アーティファクト
    -  [追加]ボタンをクリックし、"SourceArtifact"を追加
  - Amazon ECS タスク定義
    - "SourceArtifact"に変更
  - AWS CodeDeploy AppSpec ファイル
    - "SourceArtifact"に変更
  - 「編集: Deploy」の[完了]をクリック、画面上部の[保存]ボタンをクリックし、パイプラインを保存する画面で[保存]ボタンをクリックし、設定を保存する
  - [変更をリリース]ボタンをクリックし、Pipelineを再度実行する
