# テスト用CF設定
- "OAC"という機能でS3バケットを公開せずにCF設定する内容をやってみる
- [参考](https://qiita.com/polarbear08/items/84b7add0ddd309abda74)

---
## S3バケット作成
- 普通に作成、パブリック公開や、アクセス許可、web公開設定は入れない
- index.htmlをバケット内に作成する

## CF設定
### OAC作成
CF > セキュリティ > オリジンアクセス
-「オリジンアクセス」画面右上の[コントロール設定を作成]ボタンをクリック
- 「Create new OAC」画面にて以下の項目を設定し、[Create]ボタンをクリックする
  - 名前
    - 適宜
  - 説明
    - 必要に応じて
  - 署名動作
    - "署名リクエスト(推奨)"にチェック(デフォルト)
      - "認証ヘッダーをうわkが来しない"は未チェック
  - オリジンタイプ
    - S3

### CFディストリビューション作成
CF > ディストリビューション
- ディストリビューションを作成をクリック
- [ディストリビューションを作成]画面にて以下の設定を行い"ディストリビューションを作成"ボタンをクリックする
  - オリジン
    - Origin domain
      - 作成したS3バケットを指定
    - 名前
      - 自動で入っているものを利用
    - オリジンアクセス
      - ”Origin access control settings (recommended)”を選択
    - Origin access control
      - 上記を選択した場合に表示される項目
      - 作成したOACを指定
      - ”S3 バケットポリシーを更新する必要があります”と警告が評されるがこのタイミングでは無視でOK
  - デフォルトのキャッシュビヘイビア
    - デフォルトのまま
  - ビューワー
    - ビューワープロトコルポリシー
      - ”HTTPS only”を選択
    - 許可された HTTP メソッド、ビューワーのアクセスを制限する
      - デフォルトのまま
  - キャッシュキーとオリジンリクエスト
    - デフォルト
  - 関数の関連付け - オプション
    - デフォルト
  - ウェブアプリケーションファイアウォール (WAF)
    - "セキュリティ保護を有効にしないでください"を選択
      - 検証のため
  - 設定
    - デフォルトのまま
  - Standard logging 
    - あとで設定する
- 作成が完了すると画面上部に"S3バケットポリシーを更新する必要があります"警告が表示されるので
  [ポリシーをコピー]ボタンをクリックしてコピーする
```
{
        "Version": "2008-10-17",
        "Id": "PolicyForCloudFrontPrivateContent",
        "Statement": [
            {
                "Sid": "AllowCloudFrontServicePrincipal",
                "Effect": "Allow",
                "Principal": {
                    "Service": "cloudfront.amazonaws.com"
                },
                "Action": "s3:GetObject",
                "Resource": "arn:aws:s3:::<S3バケット名>/*",
                "Condition": {
                    "StringEquals": {
                      "AWS:SourceArn": "arn:aws:cloudfront::<cloudfrontのARN>"
                    }
                }
            }
        ]
      }
```  
## S3バケットポリシーの変更
- 作成したバケットを表示し、[アクセス許可]タブ内のバケットポリシーを編集する

## 動作確認
- 作成したディストリビューションドメインにアクセスする
- この際度面だけだとDenyになってしまうのでindex.htmlまで指定する

## ドメイン設定
- 取得しているドメイン設定を行う
- https化するために証明書設定を行う
  - 証明書はバージニア北部のものしか利用できないので注意
  - 検証はDNS検証とする
    - レコードはRoute53に自動登録される
- 作成したディストリビューションをクリック
- [一般]タブ > 設定項目の[編集]ボタンをクリック
- 「設定を編集」画面にて以下の設定を行い[変更を保存]ボタンをクリックする
  - Alternative domain name (CNAMEs) - optional
    - [項目を追加]ボタンをクリック
    - 上部にFQDNを入れる項目が表示されるので入力
  - Custom SSL certificate - optional
    - ACMで作成した証明書を指定
    - 証明書を指定すると"Security policy"項目が表示されるがそのままにしておく

## route53に登録
- レコード作成時の指定
  - レコード名
    - 設定したFQDNになるようにする
  - レコードタイプ
    - A
  - エイリアス
    - チェック
    - トラフィックのルーティング先が選択できるようになるので
      - Cloudfront ディストリビューションへのアクセス
      - 作成したディストリビューションを指定

## 動作確認
- 追加後設定したFQDNでアクセステストを実施する
   - https://<ドメイン名>/
