# ec2料金について
検証や一時的な利用の場合であれば普通に作成して、必要に応じてインスタンスを終了するか落としておけば料金は発生しない。   
本番稼働や、常時稼働等長期的に稼働する場合は費用を抑えることができる。

- 細かい話はクラスメゾットさんがまとめているのでここを参照してもらうといいかも
  - [EC2 でリザーブドインスタンス（RI）と Savings Plans （SP）のどちらを選ぶべきか？基準とするための最強の比較表を作ってみた](https://dev.classmethod.jp/articles/ec2-reserved-instances-savings-plans-comparison/)
- また後で説明するキャパシティの考え方はサーバワークスさんがここにまとめているのでこちらも合わせて参考にしてもらえると
  - [キャパシティ予約の種類と SP / RI の関係について整理する](https://blog.serverworks.co.jp/tech/2020/02/26/capacity-reservations/)

- 結論どれがいいのが知りたいのであれば [最終項](# 結局どれを選べば？) に記載しているのでそちらを見ていただければと
---
# 購入プランについて([参考](https://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/instance-purchasing-options.html))
AWSでインスタンスを稼働する場合、いくつかの料金プランがある
- On-Demand
- Spot
- reserved
- Savings Plans 

## On-Demand (オンデマンド)
- ec2を起動した場合、この方式の支払いとなる。
- インスタンスステータスが"runnning"の状態のみ料金が発生
- 秒数(最低60秒)から
- 用途として
   - 短期間で不規則なワークロードがあり、中断できない場合に利用
   - 一時的なバッチ処理や使っているタイミングで停止できない検証等

## Spot (スポット)
- ec2起動時にリクエストした場合に適用できる料金
- 例えばt3.medium(2vCPU,MEM 4GiB)だと以下の料金となる
   - オンデマンド : 0.0544 USD
   - スポット     : 0.0163 USD
- 注意点として
  - 余剰リソースを安価で提供しているため、利用したいインスタンスタイプが選択できないことがある
  - キャパシティの都合により停止する可能性がある
  - 料金は固定ではない
     - 最高でもオンデマンドよりは安いが、割引率は状況に応じて変化するとのこと
- 用途として
  - 短期間で処理が終わるワークロード(例えば数秒で終わる処理)
  - 途中で止まっても再開すれば処理が続けられるワークロード
  - 台数が多く、ある程度費用を抑えたい場合で上記条件でワークロードが継続可能であれば有用
  - **通常時の提案としてはあまり利用しないこと!**

## reserved (リザーブド、以下RI)
- よく見積もりに利用されるディスカウントプラン
- 割引率は固定であるため、算出もしやすい
- 例えばt3.medium(2vCPU,MEM 4GiB)を3年間利用前提だと以下の料金となる
  - オンデマンド              : 0.0544 USD
  - RI(スタンダート) 3年前払い : 0.020 USD (62% OFF ) 前払いして 538 USD
- RIにはいくつかプランが有るため次項にて説明する

## Savings Plans (セービングプラン、以下SP)
- リソースに対してではなく、利用する時間に対してコミットすることでディスカウントされるプラン
- 適用されるリソース以下
   - ec2インスタンス
   - Fargate
   - Lambda
   - Sagemaker
- プランタイプはいくつかあるが今回の話ではec2をターゲットにしているので２つのプランの説明を次項で行う


---
# 各プランの説明

### RIの種類([参考](https://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/ec2-reserved-instances.html))
2つのパターンがあるのでそれぞれの比較表を作成

|項目|リージョンRI|ゾーンRI|
|---|---|---|
|キャパシティ予約|されない|される|
|AZの柔軟性|リージョン内 適用|指定したAZ内 適用|
|インスタンスサイズの柔軟性|インスタンスファミリー内のインスタンスの使用に対して、サイズを問わず、リザーブドインスタンス 割引が適用される|インスタンスサイズの柔軟性なし|
|購入をキューに入れる|入れることができる|入れることができない|

以下それぞれの項目についての説明
- キャパシティ予約
  - インスタンスが必ず起動できるかできないかどうか、予約されていないと利用したいときに起動できない可能性がある
- AZの柔軟性
  - 複数のAZでインスタンスが稼働している場合、それぞれのAZで台数が可変な場合はリージョンRIの検討余地がある
  - 逆に単一AZや、複数のAZでそれぞれの台数が固定の場合はゾーンRIでの検討余地がある
- インスタンスサイズの柔軟性
  - ゾーンRIの場合は購入したRIのインスタンスタイプのみ適用される
     - ※ ただし、後でRIタイプを変更することは可能である。ただしこの説明は割愛。
  - リージョンRIの場合は”正規化係数”というものによって別のインスタンスサイズにも適用される
    - 例) t3.medium (正規化係数 2)の場合、t2.small (正規化係数 1) x2 を起動しても適用される
    - 正規化係数は[ここに表がある](https://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/apply_ri.html)ので参照してもらえればと
- 購入をキューに入れる
   - 予約購入みたいなもの、例えばRIが期限切れになるタイミングで新しいRIを購入する予約をしておくことにより予算が無駄なく消化される

### RIの場合、どちらを選べば良いのか？
- 見積もり作成時であれば割引率は変わらないのでどちらでも良い(AWSの見積もりでも区別はされてないので)
- リージョナルRI
   - インスタンスサイズが可変であったり、AZが複数あり、台数が可変である場合はこちらを検討するとよいかも
- ゾーンRI
   - リソースが固定で、構成も変わらないのであればこちらを検討するとよいかも

---
### Savings Plansの種類([参考](https://docs.aws.amazon.com/ja_jp/savingsplans/latest/userguide/what-is-savings-plans.html))
Saving Planは以下の3つがある
- Compute Savings Plan
  - 適用は前項で説明した通りec2,Fargate,Lambdaに適用される
  - インスタンスファミリーの変更や、リージョンを変更、OSを変えても適用され続ける
  - 割引率は最大66%

- EC2 Instance Savings Plans
  - 名前の通りec2に特化した割引プラン
  - インスタンスファミリー(東京のm5など)のコミットは必要
  - ファミリーサイズ、OS、テナンシーを変更しても適用され続ける

- SageMaker Savings Plans
   - これはSageMakerで利用するインスタンスファミリーに特化しているので説明は割愛

---
## 各割引プランの比較
[Savings Plans とは?](https://docs.aws.amazon.com/ja_jp/savingsplans/latest/userguide/what-is-savings-plans.html) ページの内容を再掲

|内容|Compute Savings Plans|EC2 Instance Savings Plans|コンバーチブル RI|スタンダード RI|
|---|---|---|---|---|
|オンデマンドに比べ節約|最大66%|最大72%|最大66%|最大72%|
|金銭的コミットメントと引き換えに価格を下げる|✓|✓|-|-|
|すべてのインスタンスファミリーに自動的に価格を適用|✓|-|-|-|
|任意のインスタンスサイズに自動的に価格を適用|✓|✓|-※|-※|
|すべてのテナンシーまたはOSに自動的に価格を適用|✓|✓|-|-|
|Fargate を使用して Amazon ECS と Amazon EKS に自動的に適用|✓|-|-|-|
|Lambda に自動的に適用されます|✓|-|-|-|
|AWS地域全体に価格を自動的に適用|✓|-|-|-|
|1年または3年の期間オプション|✓|✓|✓|✓|
- ※ リージョナルコンバーチブル RI とリージョンスタンダード RI では、インスタンスサイズを柔軟に設定できる。

---
# 結局どれを選べば？
- RIとSPはそれぞれ以下の特徴がある
   - RI
     - ec2インスタンスに対してのみ適用
     - インスタンスタイプに応じて適用
   - SP
     - プランにもよるが、EC2だけではなくFargateやLambdaにも適用できる
     - 全体的に利用予定の料金に対して割引が適用される
- 中身だけを見ると"EC2 Instance Savings Plans"が一番お得な気がするがSavingPlansは全体的な料金に対してとなるため、リソースごとの利用率が見えづらい
- リソース全体という曖昧な枠組みとなるため、例えば利用コスト最適化を検討する場合どこを減らせば良いのかというところが分かりづらくなる
- RIのメリットとしてはインスタンスタイプごとなのでより計画的に割引購入ができることとなる
- 更にゾーンRIであればキャパシティ予約ができるため、使いたいときに使えないということがないため、確実に確保できる利点がある

- なお、概算や提案時であればRIで算出するとどこにどれぐらい予算がかかるのかが見えやすくなるため提案がし易い
- SPはある程度システムが稼働してリソース可変が多い状況においてやFargateやLambdaを一緒に利用する場合においては有効かと
