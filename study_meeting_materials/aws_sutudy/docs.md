---
marp: true
# theme: gaia
size: 16:9
paginate: true
headingDivider: 3
header: "**AWS 勉強会**"


---

# AWS勉強会
@y_soma

- 初回実施 2023/04/19

## アジェンダ
- 提案前の要件ヒアリングについて
- AWSアカウントが払い出しされたあとにやっておくこと
- 構築例

## お客様に提案する際にヒアリングすること
###  何をやりたいか？
- 要件によってはマネージド・サービスオンリーで構成できることが可能なのでこのあたりをヒアリングする
  - 例1) FTPを利用してデータを保存したい
    - AWS Transfer FamilyのSFTPサービスが利用可能である
  - 例2) 定期的にバッチ処理を実行したい
    -  LambdaやAWS Batchが利用できる
  - 例3) 静的Webサイトを公開したい
    - Cloud Front ＋ S3 での構成が可能
- ※ ただし、要件によってはやっぱりサーバが必要ということもある   

### リプレースなのか、新規なのか?
- 新規であれば設計に自由度が出るため、マネージド・サービスが利用しやすい
- リプレースの場合コンテナ環境であればECSやEKSも利用できるで一部マネージドに変えることも可能

### ec2を使いたい場合
- ネットワークが既存システムに接続する要件があるか確認する
  - 仮に要件がなさそうでも将来的に接続する可能性があるかもヒアリングする
- スペック
  - リプレースであればまずは現状稼働しているマシンと同等のインスタンスやストレージサイズを選択
  - 新規である場合はミドルウェア稼働要件を満たすスペックを選定する
- スペックに関しては後で変更も可能なので仮としてその旨を提案書に記載する

### OS
- Windowsの場合ライセンス費用は含まれる
- 持ち込みの場合は専有ホスト(物理サーバのこと？)でないといけないため持ち込みできないと考えたほうが良い
- Amazon LinuxはEOLに注意
  - よほどなことがない限り最新版を利用すると良い

### 踏み台
- AWS環境に入るために踏み台が必要か確認
- あると便利だがその分踏み台用のアカウント管理を考慮する必要あり
  - Windowsの場合デフォルトで2人までしか同時に接続できない
      - [参考](https://docs.aws.amazon.com/ja_jp/AWSEC2/latest/WindowsGuide/connecting_to_windows_instance.html)

### ミドルウェア要件の確認
- 要件によってはマネージド・サービスが利用できる
  - RDS (mysql、postgresql、SQL Server等)
  - ElastiCache (Redis、memcache)
- マネージド・サービスの場合バージョン的な制限は発生するが冗長化やバックアップ設計がAWS内で完結するので運用が楽になる

### 可用性
- 冗長化が必要か？  DR構成は必要か？
- 当然冗長化やDR構成が必要な場合費用も増える
- DRの場合はサービスによっては対応してないものがあったり、復旧に時間がかかるのでこのあたりは提案時に前提条件として説明はしておく必要あり

### バックアップ
- 必要に応じてスナップショットや[AWS Backup](https://docs.aws.amazon.com/ja_jp/aws-backup/latest/devguide/whatisbackup.html)が利用できる
- ec2やrdsが該当

### セキュリティ
- 自社にてガイドラインがあるかを確認
- ガイドラインが設定されている場合はAWS標準の暗号化で要件が満たせるかを確認しておく

### デプロイ
- コンテナ運用の要件であればデプロイ環境が必要である
- AWSの場合AWS Code系が利用できる
  - aws CodeCommit : gitリポジトリ
  - aws CodeBuild  : コンテナイメージをビルド
  - aws CodeDeploy : ecsやeksにコンテナをデプロイ
  - aws CodePipeline : 上記をまとめて操作できる
- 外部サービスを利用してデプロイする場合は経路がどうなるかを確認
- 金額の考慮はざっくりでよいが、AWS内だけのデプロイになるのか等、デプロイ要件があるかのヒアリングは必要

### よくある構成例
- LAMP構成
  - WEBサーバを冗長化
  - 冗長化されているのでロードバランサを利用
  - RDSを利用
  - データバックアップにS3を利用
![bg right:40% height:400](images/exsample.png)

###### ※"LAMP"とは？
   - Linux、apache(Webサーバ)、MySQL(DB)、PHP等(プログラム)を示す構成

## まとめ
- 要件によっては構成がガラッと替わるはずなので何をやりたいかをしっかりとヒアリング
- マネージド・サービスやサーバレス環境は率先して提案していきたい
- ヒアリング項目はシート化して漏れがないようにしておくと良いかも

# 設計するときに気をつけること

### (ざっくりと)
- ネットワーク設計
  - 既存ネットワークと重複しないように注意する
- ネットワークは小さくしすぎない
  - サブネットを設定したときに１～３までは利用される
  - ELB（ロードバランサ）やECS等のオートスケールされるものを利用するとIPアドレスが枯渇する可能性がある
- セキュリティグループは絞り過ぎない
  - インバウンド or アウトバウンドを指定した場合戻りの通信はデフォルトの設定に任せる
  -  (※ このあたりは先方のガイドラインがあればそれに従う)
- IAMロールやアカウントは使い回しをしないようにする

# アカウントが払い出しされたあとにやること

## アカウント払い出し後設定しておくと良いこと
- 新規の場合を想定
- [参考情報:AWSアカウントを不正利用・攻撃から守るためにやるべき設定のまとめ](https://www.cloudsolution.tokai-com.co.jp/white-paper/2022/0127-286.html#anc-03)

##  rootユーザ
- MFAデバイス設定の実施
- rootユーザは作業で利用しない
- アクセスキーも発行しない

## 作業用アカウント
- IAMユーザー作成
  - SSOが使える場合はSSOで作成
- 権限は”AdministratorAccess”で問題なし
  - 構築終了後適切なアカウント権限に変更する
- パスワードポリシーの要件を定義する
- MFAデバイスを有効化する
- 必要に応じてIAMポリシーで接続元制限を実施する

## AWS CloudTrailの有効化
- 「AWS CloudTrail」とは？
  - AWSアカウントの作成時点から自動ですべての操作を記録するサービス
  - ec2やコンテナへのログイン後の操作は記録されないので注意！
- ※ 料金がかかる
  - 詳しくは[ここ](https://aws.amazon.com/jp/cloudtrail/pricing/)を参照

# 構築例

### 汎用アプリケーションで処理を実行したい
- 想定される構成としてec2を起動し、プログラムを実行するというパターンが考えられる
- この場合構築すべきものは以下と想定
  - vpc
    - サブネット
    - インターネットゲートウェイ
    - ルートテーブル
  - ec2
    - インターネットへの接続あり
    - 接続元は制限したい


## 構築例構成

### 構成説明
- [172.30.0.0/16]ネットワークのVPCを作成
- パブリックサブネットを2つ作成
  - az-a 172.30.11.0/24
  - az-c 172.30.12.0/24
- IGWを作成し、インターネットに接続できるようにする
- EC2を起動し、インターネットからSSH接続できるようにする
   
![bg right:40% height:400](images/demo-example3.svg)

## デモ (今回はやってない)
- AWS CLIを利用して構築例構成を作ってみる
  - [ドキュメント](https://github.com/YoichiSoma/sites/blob/main/docs/aws/basic/b1-0.md)

## おまけ
- [Plumi AI](https://www.pulumi.com/ai/)
  - ”Pulumi”とはIaCツールである
  - AWS、Azure、GCP等いろいろなクラウドに対応
  - コードはYAMLや他言語で作成可能である
    - インフラエンジニアであれはYAMLで書くことが多い
  - ”Plumi AI”は自然言語で構築したい構成を入力するとサンプルコードを作成してくれる
    - 例えば"create ec2"や"create vpc on aws"など
- ※ Pulumiを使ったことがないのとIaCを利用するならTerraformが大多数なので作成デモは省略


### おつかれさまでした


---
## 質問事項
勉強会開催時に出てきた質問をまとめてみました

### cloudwatch
- どんな監視ができる？
  - [ここに](https://www.cloudsolution.tokai-com.co.jp/white-paper/2021/1101-267.html)情報がまとまってます
- どこまで使えるか？
  - 大抵のことはできるが、細かいことをやるときの設計ハードルが高い
  - ハイブリットクラウドや複数のクラウドを使っている場合は別の監視サービスを利用するとよいかも

### ディスク拡張
- 拡張はできるのか？
  - ストレージ最適化インスタンスのインスタンスストア(NVMe)は拡張できない
    - インスタンスストアのデータはインスタンスが停止や休止した場合はデータが消える
      - ※再起動は大丈夫
    - [参考:インスタンスストア](https://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/InstanceStorage.html)
  - EEBSボリュームは拡張可能である
    - EBSは拡張可能であるが小さくはできない
- どうやって拡張するの？
  - LinuxであればOSのファイルシステム拡張機能を利用して拡張できる
  - [参考:](https://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/recognize-expanded-volume-linux.html)

### バックアップ
- AWSバックアップで何ができるの？
  - [こちらを参照](https://docs.aws.amazon.com/ja_jp/aws-backup/latest/devguide/whatisbackup.html)


### KMS HSM の違い
- [こちらを参照](https://qiita.com/ayumi_imai/items/6a74c6327e0f6a1ac7db)



